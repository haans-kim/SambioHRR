#!/usr/bin/env python3
"""
SAMBIO HRR Data Uploader  
Excel ë°ì´í„° ì—…ë¡œë“œ ë° ê´€ë¦¬ ì• í”Œë¦¬ì¼€ì´ì…˜
SambioHR5 ìŠ¤íƒ€ì¼ ì ìš©

ì‹¤í–‰ ë°©ë²•:
cd excel-upload-server
./venv/bin/streamlit run streamlit_app.py --server.port 8501
"""

import streamlit as st
import pandas as pd
from pathlib import Path
import sys
import logging
from datetime import datetime
import tempfile
import os

# í˜„ì¬ ë””ë ‰í† ë¦¬ë¥¼ Python ê²½ë¡œì— ì¶”ê°€
current_dir = Path(__file__).parent
sys.path.insert(0, str(current_dir))

from models.data_types import DATA_TYPES
from core.db_manager import DatabaseManager
from core.excel_loader import ExcelLoader
from handlers.data_transformers import get_transformer

# ë¡œê¹… ì„¤ì •
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Database path
DB_PATH = Path("/Users/hanskim/Projects/SambioHRR/sambio_human.db")

def init_session_state():
    """ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”"""
    if 'upload_files' not in st.session_state:
        st.session_state.upload_files = {}
        for data_type in DATA_TYPES.keys():
            st.session_state.upload_files[data_type] = []

def get_data_stats():
    """ë°ì´í„°ë² ì´ìŠ¤ í†µê³„ ê°€ì ¸ì˜¤ê¸°"""
    try:
        db_manager = DatabaseManager(str(DB_PATH))
        stats = []

        for data_type_id, data_type_info in DATA_TYPES.items():
            table_name = data_type_info.table_name

            # í…Œì´ë¸” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
            if not db_manager.table_exists(table_name):
                stats.append({
                    "ë°ì´í„° ìœ í˜•": data_type_info.label,
                    "ë“±ë¡ íŒŒì¼": "0ê°œ",
                    "Pickle ìƒíƒœ": "ì—†ìŒ",
                    "ë°ì´í„°í”„ë ˆì„": table_name,
                    "í–‰ ìˆ˜": "-",
                    "ìµœì¢… ìˆ˜ì •": "-"
                })
                continue

            # í–‰ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            row_count = db_manager.get_row_count(table_name)

            # ë“±ë¡ëœ íŒŒì¼ ì •ë³´
            uploaded_files = st.session_state.upload_files.get(data_type_id, [])
            file_info = f"{len(uploaded_files)}ê°œ" if uploaded_files else "0ê°œ"

            # ìµœì¢… ìˆ˜ì •ì¼
            last_modified = datetime.now().strftime("%Y-%m-%d") if row_count > 0 else "-"

            stats.append({
                "ë°ì´í„° ìœ í˜•": data_type_info.label,
                "ë“±ë¡ íŒŒì¼": file_info,
                "Pickle ìƒíƒœ": "ìˆìŒ" if row_count > 0 else "ì—†ìŒ",
                "ë°ì´í„°í”„ë ˆì„": table_name,
                "í–‰ ìˆ˜": f"{row_count:,}" if row_count > 0 else "-",
                "ìµœì¢… ìˆ˜ì •": last_modified
            })

        return pd.DataFrame(stats)

    except Exception as e:
        logger.error(f"ë°ì´í„° í†µê³„ ì¡°íšŒ ì‹¤íŒ¨: {e}")
        return pd.DataFrame()

def render_data_status_table():
    """ë°ì´í„° ìƒíƒœ í…Œì´ë¸” ë Œë”ë§"""
    st.markdown("## ğŸ“Š ë°ì´í„° ì—…ë¡œë“œ ê´€ë¦¬")
    st.markdown("### ë°ì´í„° ì—…ë¡œë“œ ë° ê´€ë¦¬")

    df_status = get_data_stats()

    if not df_status.empty:
        row_height = 35
        header_height = 40
        total_height = len(df_status) * row_height + header_height + 20

        st.dataframe(
            df_status,
            use_container_width=True,
            hide_index=True,
            height=total_height
        )
    else:
        st.warning("ë°ì´í„° ìƒíƒœë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

def render_file_upload_section():
    """íŒŒì¼ ì—…ë¡œë“œ ì„¹ì…˜ ë Œë”ë§"""
    st.markdown("---")
    st.markdown("#### ğŸ“ íŒŒì¼ ë“±ë¡")

    data_type_labels = {dt_id: dt_info.label for dt_id, dt_info in DATA_TYPES.items()}
    selected_label = st.selectbox(
        "ë°ì´í„° ìœ í˜• ì„ íƒ",
        options=list(data_type_labels.values()),
        key="data_type_selector"
    )

    selected_type = None
    for dt_id, label in data_type_labels.items():
        if label == selected_label:
            selected_type = dt_id
            break

    if selected_type:
        data_type_info = DATA_TYPES[selected_type]
        st.info(f"ğŸ“Š {data_type_info.description}")

        uploaded_files = st.file_uploader(
            "Excel íŒŒì¼ ì„ íƒ (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)",
            type=['xlsx', 'xls'],
            accept_multiple_files=True,
            key=f"file_uploader_{selected_type}"
        )

        if uploaded_files:
            if st.button("â• íŒŒì¼ ì¶”ê°€", key="add_files"):
                for file in uploaded_files:
                    file_info = {
                        "name": file.name,
                        "size": file.size,
                        "file": file
                    }
                    existing_names = [f['name'] for f in st.session_state.upload_files[selected_type]]
                    if file_info['name'] not in existing_names:
                        st.session_state.upload_files[selected_type].append(file_info)
                st.success(f"{len(uploaded_files)}ê°œ íŒŒì¼ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.")
                st.rerun()

        if st.session_state.upload_files[selected_type]:
            st.markdown(f"##### ğŸ“‹ {data_type_info.label} ë“±ë¡ íŒŒì¼")

            for idx, file_info in enumerate(st.session_state.upload_files[selected_type]):
                col1, col2, col3 = st.columns([3, 1, 1])
                with col1:
                    st.text(file_info["name"])
                with col2:
                    st.text(f"{file_info['size'] / (1024*1024):.2f} MB")
                with col3:
                    if st.button("ğŸ—‘ï¸ ì‚­ì œ", key=f"remove_{selected_type}_{idx}"):
                        st.session_state.upload_files[selected_type].pop(idx)
                        st.rerun()

def render_action_buttons():
    """ì•¡ì…˜ ë²„íŠ¼ ë Œë”ë§"""
    st.markdown("---")

    data_type_labels = {dt_id: dt_info.label for dt_id, dt_info in DATA_TYPES.items()}
    selected_label = st.selectbox(
        "ë¡œë“œí•  ë°ì´í„° ìœ í˜•",
        options=list(data_type_labels.values()),
        key="load_data_type_selector"
    )

    selected_type = None
    for dt_id, label in data_type_labels.items():
        if label == selected_label:
            selected_type = dt_id
            break

    col1, col2 = st.columns([1, 1])

    with col1:
        if st.button("ğŸ“¤ ë°ì´í„° ë¡œë“œ", type="primary", use_container_width=True):
            if selected_type:
                load_data(selected_type)
                st.rerun()

    with col2:
        if st.button("ğŸ”„ ìƒˆë¡œê³ ì¹¨", use_container_width=True):
            st.rerun()

def load_data(selected_type):
    """ë°ì´í„° ë¡œë“œ ì²˜ë¦¬"""
    progress_bar = st.progress(0)
    status_text = st.empty()

    try:
        data_type_info = DATA_TYPES[selected_type]
        files = st.session_state.upload_files[selected_type]

        if not files:
            st.warning("ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
            return

        status_text.text(f"ğŸ“Š {data_type_info.label} ë¡œë”© ì¤‘...")
        progress_bar.progress(0.1)

        excel_loader = ExcelLoader()
        db_manager = DatabaseManager(str(DB_PATH))

        all_dfs = []
        temp_files_to_delete = []

        total_files = len(files)
        for idx, file_info in enumerate(files):
            status_text.text(f"ğŸ“– íŒŒì¼ ë¡œë”© ì¤‘: {file_info['name']} ({idx+1}/{total_files})")
            progress = 0.1 + (idx / total_files) * 0.4
            progress_bar.progress(progress)

            with tempfile.NamedTemporaryFile(delete=False, suffix='.xlsx') as tmp_file:
                tmp_file.write(file_info['file'].getbuffer())
                tmp_path = tmp_file.name

            try:
                df = excel_loader.load_excel(tmp_path)
                if df is not None and not df.empty:
                    all_dfs.append(df)
                temp_files_to_delete.append(tmp_path)
            except Exception as e:
                if os.path.exists(tmp_path):
                    os.unlink(tmp_path)
                raise e

        if all_dfs:
            status_text.text("ğŸ”„ ë°ì´í„° ë³‘í•© ì¤‘...")
            progress_bar.progress(0.6)

            combined_df = pd.concat(all_dfs, ignore_index=True)
            logger.info(f"ë°ì´í„° ë³‘í•© ì™„ë£Œ: {len(combined_df):,}í–‰")

            transformer = get_transformer(selected_type)
            if transformer:
                status_text.text("ğŸ”„ ë°ì´í„° ë³€í™˜ ì¤‘...")
                progress_bar.progress(0.7)
                combined_df = transformer(combined_df)

            status_text.text("ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì¤‘...")
            progress_bar.progress(0.8)

            db_manager.insert_dataframe(data_type_info.table_name, combined_df)

            progress_bar.progress(1.0)
            status_text.text("âœ… ë¡œë“œ ì™„ë£Œ!")

            st.session_state.upload_files[selected_type] = []

            for tmp_path in temp_files_to_delete:
                try:
                    if os.path.exists(tmp_path):
                        os.unlink(tmp_path)
                except Exception as del_error:
                    logger.warning(f"ì„ì‹œ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: {tmp_path} - {del_error}")

            st.success(f"ğŸ‰ {data_type_info.label} ì—…ë¡œë“œ ì™„ë£Œ! ({len(combined_df):,}í–‰)")

        else:
            st.warning("ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")

    except Exception as e:
        st.error(f"âŒ ë¡œë“œ ì‹¤íŒ¨: {e}")
        logger.error(f"ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: {e}")
    finally:
        progress_bar.empty()
        status_text.empty()

def render_action_buttons():
    """ì•¡ì…˜ ë²„íŠ¼ ë Œë”ë§"""
    st.markdown("---")

    data_type_labels = {dt_id: dt_info.label for dt_id, dt_info in DATA_TYPES.items()}
    selected_label = st.selectbox(
        "ë¡œë“œí•  ë°ì´í„° ìœ í˜•",
        options=list(data_type_labels.values()),
        key="load_data_type_selector"
    )

    selected_type = None
    for dt_id, label in data_type_labels.items():
        if label == selected_label:
            selected_type = dt_id
            break

    col1, col2 = st.columns([1, 1])

    with col1:
        if st.button("ğŸ“¤ ë°ì´í„° ë¡œë“œ", type="primary", use_container_width=True):
            if selected_type:
                load_data(selected_type)
                st.rerun()

    with col2:
        if st.button("ğŸ”„ ìƒˆë¡œê³ ì¹¨", use_container_width=True):
            st.rerun()

def main():
    """ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜"""
    st.set_page_config(
        page_title="SAMBIO HRR Data Uploader",
        page_icon="ğŸ“Š",
        layout="wide",
        initial_sidebar_state="collapsed"
    )

    init_session_state()

    with st.sidebar:
        st.markdown("## ğŸ“Š SAMBIO HRR Data Uploader")
        st.markdown("---")
        st.markdown("### ğŸ¯ ì£¼ìš” ê¸°ëŠ¥")
        st.markdown("""
        - **Excel íŒŒì¼ ì—…ë¡œë“œ**: ëŒ€ìš©ëŸ‰ ë°ì´í„° ì²˜ë¦¬
        - **ìë™ ë³‘í•©**: ì—¬ëŸ¬ ì‹œíŠ¸ ìë™ í†µí•©
        - **DB ì €ì¥**: SQLite ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬
        - **ë°ì´í„° ì¡°íšŒ**: ì‹¤ì‹œê°„ ë°ì´í„° í™•ì¸
        """)

        st.markdown("---")
        st.markdown("### â„¹ï¸ ì‚¬ìš©ë²•")
        st.markdown("""
        1. **íŒŒì¼ ë“±ë¡**: Excel íŒŒì¼ ì„ íƒ ë° ì¶”ê°€
        2. **ë°ì´í„° ë¡œë“œ**: ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ì²˜ë¦¬ ì‹œì‘
        3. **ìƒíƒœ í™•ì¸**: ì‹¤ì‹œê°„ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§
        4. **ìƒˆë¡œê³ ì¹¨**: í…Œì´ë¸” ì—…ë°ì´íŠ¸
        """)

        st.markdown("---")
        if DB_PATH.exists():
            st.success(f"âœ… DB ì—°ê²°ë¨")
            st.caption(f"ğŸ“ {DB_PATH.name}")
        else:
            st.warning("âš ï¸ DB íŒŒì¼ ì—†ìŒ")

    try:
        render_data_status_table()
        render_file_upload_section()
        render_action_buttons()

    except Exception as e:
        st.error(f"âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ì˜¤ë¥˜: {e}")
        logger.error(f"ì• í”Œë¦¬ì¼€ì´ì…˜ ì˜¤ë¥˜: {e}", exc_info=True)

if __name__ == "__main__":
    main()
